<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Cast Sender Demo</title>
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        input, select, button {
            margin: 10px 0;
            padding: 8px;
            width: 100%;
        }
    </style>
</head>
<body>

    <h1>Cast Sender Demo</h1>

    <label>Application ID:</label>
    <input type="text" id="appId" placeholder="Eg: YOUR_APP_ID_HERE">

    <label>Media URL:</label>
    <input type="text" id="mediaUrl" placeholder="Eg: https://example.com/video.mp4">

    <label>Media Type:</label>
    <select id="mediaType">
        <option value="video/mp4">MP4</option>
        <option value="application/x-mpegURL">M3U8</option>
        <option value="video/youtube">YouTube (Iframe)</option>
    </select>

    <button id="castButton">Cast</button>

    <script>
        let castSession = null;

        document.getElementById('castButton').addEventListener('click', async () => {
            const appId = document.getElementById('appId').value.trim();
            const mediaUrl = document.getElementById('mediaUrl').value.trim();
            const mediaType = document.getElementById('mediaType').value;

            if (!appId || !mediaUrl) {
                alert('Please fill in Application ID and Media URL.');
                return;
            }

            await initializeCastApi(appId);
            castMedia(mediaUrl, mediaType);
        });

        async function initializeCastApi(appId) {
            return new Promise((resolve, reject) => {
                const context = cast.framework.CastContext.getInstance();
                context.setOptions({
                    receiverApplicationId: appId,
                    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                });

                context.requestSession()
                    .then(() => {
                        castSession = context.getCurrentSession();
                        resolve();
                    })
                    .catch(err => {
                        console.error('Failed to request session:', err);
                        alert('Failed to connect to Chromecast.');
                        reject(err);
                    });
            });
        }

        function castMedia(mediaUrl, mediaType) {
            if (!castSession) {
                alert('No Cast session established.');
                return;
            }

            let contentId = mediaUrl;
            if (mediaType === "video/youtube") {
                // Nếu là YouTube, cần lấy ID từ URL
                const videoId = extractYouTubeId(mediaUrl);
                if (!videoId) {
                    alert('Invalid YouTube URL.');
                    return;
                }
                contentId = videoId;
            }

            const mediaInfo = new chrome.cast.media.MediaInfo(contentId, mediaType);
            const request = new chrome.cast.media.LoadRequest(mediaInfo);

            castSession.loadMedia(request)
                .then(() => {
                    console.log('Load media request sent');
                })
                .catch(err => {
                    console.error('Load media failed', err);
                    alert('Load media failed');
                });
        }

        function extractYouTubeId(url) {
            const regExp = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
            const match = url.match(regExp);
            return match ? match[1] : null;
        }
    </script>

</body>
</html>
